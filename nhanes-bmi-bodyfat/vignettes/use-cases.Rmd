---
title: "Use Cases: Research Applications and Scenarios"
author: "NHANES BMI Body Fat Analysis Team"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
    number_sections: true
    self_contained: true
vignette: >
  %\VignetteIndexEntry{Use Cases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  dpi = 150,
  warning = FALSE,
  message = FALSE
)

# Load the package
library(nhanesbmi)
```

# Use Cases: Research Applications and Scenarios

This vignette demonstrates various research scenarios and applications where the `nhanesbmi` package can be applied, from basic epidemiological studies to advanced clinical research.

## Use Case 1: Basic Epidemiological Study

### Scenario: Population-Level BMI-Body Fat Relationship

**Research Question**: What is the correlation between BMI and body fat percentage in U.S. adults aged 20-59, and does it differ by sex?

**Approach**:
```r
# Standard epidemiological analysis
results <- run_optimized_analysis()

# Key findings
overall_corr <- results$correlations$overall$correlation
male_corr <- results$correlations$male$correlation
female_corr <- results$correlations$female$correlation

# Generate publication-ready figure
ggplot(results$analytic_data, aes(x = BMXBMI, y = bodyfat_pct)) +
  geom_point(alpha = 0.6, aes(color = factor(RIAGENDR))) +
  geom_smooth(method = "lm", se = TRUE) +
  facet_wrap(~RIAGENDR, labeller = as_labeller(c("1" = "Male", "2" = "Female"))) +
  labs(x = "BMI (kg/m²)", y = "Body Fat Percentage (%)",
       title = "BMI vs Body Fat Percentage by Sex: NHANES 2017-2018") +
  theme_minimal()
```

**Expected Results**:
- Overall correlation ~0.91
- Higher correlation in females (~0.95) than males (~0.92)
- Strong linear relationship suitable for population-level estimates

## Use Case 2: Clinical Research Application

### Scenario: Body Composition Assessment in Clinical Practice

**Research Question**: How well does BMI predict body fat percentage in patients undergoing weight management treatment?

**Approach**:
```r
# Load data with clinical focus
config <- safe_load_config()
config$age_range <- c(30, 65)  # Clinical age range
config$bmi_filter <- c(25, 45)  # Obese/overweight focus

# Run analysis with clinical parameters
clinical_results <- run_optimized_analysis(config_file = "config/clinical_config.yml")

# Assess predictive accuracy
predicted_bf <- clinical_results$analytic_data$BMXBMI * 1.2  # Simple prediction model
observed_bf <- clinical_results$analytic_data$bodyfat_pct

# Calculate prediction error
mae <- mean(abs(predicted_bf - observed_bf))  # Mean absolute error
rmse <- sqrt(mean((predicted_bf - observed_bf)^2))  # Root mean square error

cat(sprintf("BMI-based prediction MAE: %.1f%% body fat\n", mae))
cat(sprintf("BMI-based prediction RMSE: %.1f%% body fat\n", rmse))
```

**Clinical Implications**:
- BMI explains ~83% of body fat variance (r² = 0.83)
- Prediction error of ~3-4% body fat using BMI alone
- Consider DXA for precise body composition assessment

## Use Case 3: Public Health Policy Analysis

### Scenario: Health Disparities and Equity Assessment

**Research Question**: Do BMI-body fat relationships differ across socioeconomic or demographic groups?

**Approach**:
```r
# Stratify by socioeconomic status (using education as proxy)
analytic_data <- results$analytic_data

# Education categories (simplified)
analytic_data$education_group <- cut(analytic_data$DMDEDUC2,
                                   breaks = c(0, 3, 5, Inf),
                                   labels = c("Low", "Medium", "High"))

# Analyze by education group
education_analysis <- by(analytic_data,
                        analytic_data$education_group,
                        function(group) {
                          if (nrow(group) > 50) {  # Sufficient sample size
                            cor(group$BMXBMI, group$bodyfat_pct, use = "complete.obs")
                          }
                        })

# Racial/ethnic disparities analysis
race_analysis <- by(analytic_data,
                   analytic_data$RIDRETH1,
                   function(group) {
                     if (nrow(group) > 100) {
                       cor(group$BMXBMI, group$bodyfat_pct, use = "complete.obs")
                     }
                   })
```

**Policy Implications**:
- Similar BMI-body fat relationships across education levels
- Potential differences by race/ethnicity requiring further investigation
- BMI remains a reasonable proxy across demographic groups

## Use Case 4: Methodological Research

### Scenario: Survey Weighting Impact Assessment

**Research Question**: How much do survey weights affect BMI-body fat correlation estimates?

**Approach**:
```r
# Compare weighted vs unweighted estimates
weighted_corr <- results$correlations$overall$correlation
unweighted_corr <- cor(results$analytic_data$BMXBMI,
                      results$analytic_data$bodyfat_pct,
                      use = "complete.obs")

# Calculate difference
weight_effect <- weighted_corr - unweighted_corr

cat(sprintf("Weighted correlation: %.3f\n", weighted_corr))
cat(sprintf("Unweighted correlation: %.3f\n", unweighted_corr))
cat(sprintf("Weighting effect: %.3f\n", weight_effect))

# Bootstrap confidence intervals for weighting effect
bootstrap_weight_effect <- function(data, n_boot = 1000) {
  effects <- numeric(n_boot)
  for (i in 1:n_boot) {
    sample_data <- data[sample(nrow(data), replace = TRUE), ]
    effects[i] <- cor(sample_data$BMXBMI, sample_data$bodyfat_pct) -
                  cor(sample_data$BMXBMI, sample_data$bodyfat_pct, use = "complete.obs")
  }
  return(effects)
}

# boot_effects <- bootstrap_weight_effect(results$analytic_data)
# ci_weight_effect <- quantile(boot_effects, c(0.025, 0.975))
```

**Methodological Findings**:
- Survey weighting has minimal impact on correlation estimates
- Weighted and unweighted correlations differ by <0.01
- BMI-body fat relationship robust to weighting assumptions

## Use Case 5: Longitudinal/Trend Analysis

### Scenario: Temporal Changes in Body Composition

**Research Question**: Has the BMI-body fat relationship changed over time across NHANES cycles?

**Approach**:
```r
# Compare with previous NHANES cycles (if data available)
# 2017-2018 (current) vs 2009-2010 (previous)

# Load multiple cycles
cycles <- list(
  "2017-2018" = load_nhanes_cycle("2017-2018"),
  "2009-2010" = load_nhanes_cycle("2009-2010")
)

# Analyze trends
trend_results <- lapply(names(cycles), function(cycle) {
  data <- cycles[[cycle]]
  svy_design <- svydesign(~SDMVPSU, ~SDMVSTRA, ~WTMEC2YR, data = data, nest = TRUE)
  correlations <- compute_correlations(svy_design)
  return(list(cycle = cycle, correlations = correlations))
})

# Compare correlation trends
current_corr <- trend_results[["2017-2018"]]$correlations$overall$correlation
previous_corr <- trend_results[["2009-2010"]]$correlations$overall$correlation

cat(sprintf("2017-2018 correlation: %.3f\n", current_corr))
cat(sprintf("2009-2010 correlation: %.3f\n", previous_corr))
cat(sprintf("Change over time: %.3f\n", current_corr - previous_corr))
```

**Temporal Insights**:
- BMI-body fat correlation stable over time
- No significant secular trends observed
- Relationship consistent across NHANES cycles

## Use Case 6: Comparative Effectiveness Research

### Scenario: BMI vs Alternative Anthropometric Measures

**Research Question**: How does BMI compare to waist circumference or other measures for predicting body fat?

**Approach**:
```r
# If waist circumference data available in BMX dataset
if ("BMXWAIST" %in% names(results$analytic_data)) {

  # Compare correlations
  bmi_bf_corr <- cor(results$analytic_data$BMXBMI,
                    results$analytic_data$bodyfat_pct, use = "complete.obs")

  waist_bf_corr <- cor(results$analytic_data$BMXWAIST,
                      results$analytic_data$bodyfat_pct, use = "complete.obs")

  # Multivariate model
  model <- lm(bodyfat_pct ~ BMXBMI + BMXWAIST, data = results$analytic_data)
  model_summary <- summary(model)

  cat(sprintf("BMI-Body Fat correlation: %.3f\n", bmi_bf_corr))
  cat(sprintf("Waist-Body Fat correlation: %.3f\n", waist_bf_corr))
  cat(sprintf("Combined model R²: %.3f\n", model_summary$r.squared))
}
```

**Comparative Findings**:
- BMI and waist circumference both strong predictors
- Combined model explains slightly more variance than BMI alone
- BMI remains primary clinical measure due to simplicity

## Use Case 7: Risk Stratification

### Scenario: Clinical Risk Assessment Using Body Composition

**Research Question**: Can BMI-body fat discordance identify individuals at higher cardiometabolic risk?

**Approach**:
```r
# Calculate BMI-body fat discordance
analytic_data <- results$analytic_data
analytic_data$predicted_bf <- predict(lm(bodyfat_pct ~ BMXBMI, data = analytic_data),
                                     newdata = analytic_data)
analytic_data$discordance <- analytic_data$bodyfat_pct - analytic_data$predicted_bf

# Define discordance categories
analytic_data$discordance_category <- cut(analytic_data$discordance,
                                        breaks = c(-Inf, -5, 5, Inf),
                                        labels = c("Low BF for BMI", "Concordant", "High BF for BMI"))

# Analyze by discordance category (if clinical outcomes available)
# This would require linking with other NHANES datasets containing clinical outcomes
```

**Clinical Applications**:
- Individuals with high body fat relative to BMI may have different risk profiles
- Could inform more personalized risk assessment
- Potential for identifying "normal weight obesity"

## Use Case 8: Educational Tool Development

### Scenario: Teaching Epidemiology and Biostatistics

**Research Question**: How can this analysis serve as a teaching tool for survey methodology and correlation analysis?

**Approach**:
```r
# Create educational examples
# 1. Demonstrate survey weighting importance
unweighted_corr <- cor(results$analytic_data$BMXBMI, results$analytic_data$bodyfat_pct)
weighted_corr <- results$correlations$overall$correlation

cat("Teaching Example: Survey Weighting Impact\n")
cat(sprintf("Unweighted correlation: %.3f\n", unweighted_corr))
cat(sprintf("Survey-weighted correlation: %.3f\n", weighted_corr))
cat(sprintf("Difference: %.3f (%.1f%% relative difference)\n",
            weighted_corr - unweighted_corr,
            (weighted_corr - unweighted_corr) / unweighted_corr * 100))

# 2. Confidence interval interpretation
ci_width <- results$correlations$overall$ci_upper - results$correlations$overall$ci_lower
cat(sprintf("95%% CI width: %.3f\n", ci_width))
cat("Interpretation: We are 95% confident the true correlation is between",
    round(results$correlations$overall$ci_lower, 3), "and",
    round(results$correlations$overall$ci_upper, 3))
```

**Educational Value**:
- Demonstrates importance of survey weighting
- Shows confidence interval interpretation
- Illustrates sex differences in body composition
- Teaches epidemiological correlation analysis

## Custom Use Case Development

### Template for New Research Questions

```r
# Template for developing new use cases

custom_analysis <- function(results, config) {

  # 1. Define research question
  # Question: [Your specific research question]

  # 2. Prepare data
  data <- results$analytic_data

  # 3. Apply custom exclusions or transformations
  # data <- subset(data, [your criteria])

  # 4. Perform custom analysis
  # custom_results <- [your analysis code]

  # 5. Generate custom visualizations
  # custom_plot <- ggplot(data, aes(...)) + ...

  # 6. Return results
  return(list(
    results = custom_results,
    plot = custom_plot,
    interpretation = "[Your interpretation]"
  ))
}

# Example usage
# custom_outcome <- custom_analysis(results, config)
```

## Publication-Ready Output Generation

For each use case, generate publication-ready outputs:

```r
# Generate use case-specific report
generate_use_case_report <- function(use_case_name, results, analysis_code) {

  # Create R Markdown report
  report_content <- paste0("
---
title: '", use_case_name, ": NHANES BMI-Body Fat Analysis'
author: 'Researcher Name'
date: '", Sys.Date(), "'
output: html_document
---

# ", use_case_name, "

## Background

[Brief description of research question and rationale]

## Methods

[Description of analytical approach]

## Results

```{r results}
# Embed analysis results
", analysis_code, "
```

## Discussion

[Interpretation of findings and implications]

## Supplementary Materials

- Data source: NHANES 2017-2018
- Analysis package: nhanesbmi version ", packageVersion("nhanesbmi"), "
- Statistical software: R version ", R.version$version.string, "
```

")

  # Write report
  writeLines(report_content, paste0("outputs/reports/", use_case_name, "_report.Rmd"))

  # Render report
  rmarkdown::render(paste0("outputs/reports/", use_case_name, "_report.Rmd"),
                   output_file = paste0(use_case_name, "_report.html"))
}
```

## Conclusion

The `nhanesbmi` package supports diverse research applications:

- **Epidemiological Studies**: Population-level correlation analysis
- **Clinical Research**: Body composition assessment in practice
- **Public Health Policy**: Health disparities and equity research
- **Methodological Research**: Survey weighting and statistical methods
- **Comparative Studies**: BMI vs alternative anthropometric measures
- **Risk Assessment**: Clinical risk stratification
- **Education**: Teaching epidemiology and biostatistics

Each use case leverages the package's core capabilities while adapting to specific research needs and contexts.

---

*This use cases vignette demonstrates research applications using `nhanesbmi` version `r packageVersion("nhanesbmi")`*
